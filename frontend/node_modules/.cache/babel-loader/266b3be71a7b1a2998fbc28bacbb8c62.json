{"ast":null,"code":"import _regeneratorRuntime from\"/Users/bgaldino/Documents/self-service-webstore/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/bgaldino/Documents/self-service-webstore/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/bgaldino/Documents/self-service-webstore/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useEffect,useState}from\"react\";import useToken from\"../useToken\";import{Col,Container,Row}from\"react-bootstrap\";import moment from\"moment\";import{Button,Dropdown}from\"react-materialize\";import{Dialog,DialogActions,DialogContent,DialogTitle}from\"@material-ui/core\";import DatePicker from\"react-date-picker\";import io from\"socket.io-client\";import loadingImg from\"../../images/loading.gif\";import ownedImg from\"../../images/owned.png\";import\"./Assets.css\";var TERM_DEFINED=\"TermDefined\";var ONE_TIME=\"OneTime\";var EVERGREEN=\"Evergreen\";var SELLING_MODEL_TYPES={'OneTime':'One Time','Evergreen':'Evergreen','TermDefined':'Term Defined'};var SOCKET_ENDPOINT=\"https://self-service-webstore.herokuapp.com/\";var BASE_URL=\"\".concat(process.env.REACT_APP_API_ENDPOINT,\"/services/data/v\").concat(process.env.REACT_APP_API_VERSION);export default function Assets(_ref){var setCart=_ref.setCart,cart=_ref.cart;var _useToken=useToken(),token=_useToken.token,setToken=_useToken.setToken;var _useState=useState([]),_useState2=_slicedToArray(_useState,2),assets=_useState2[0],setAssets=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),open=_useState4[0],setOpen=_useState4[1];// State of popup dialog\nvar _useState5=useState(null),_useState6=_slicedToArray(_useState5,2),selectedAsset=_useState6[0],setSelectedAsset=_useState6[1];// Asset data for popup\nvar _useState7=useState(new Date()),_useState8=_slicedToArray(_useState7,2),date=_useState8[0],onDateChange=_useState8[1];var _useState9=useState(true),_useState10=_slicedToArray(_useState9,2),loading=_useState10[0],setLoading=_useState10[1];var _useState11=useState(new Map()),_useState12=_slicedToArray(_useState11,1),events=_useState12[0];// Create socket.io connection for streaming messages\nvar socket=io(SOCKET_ENDPOINT,{transports:[\"websocket\",\"polling\",\"flashsocket\",\"xhr-polling\"]});// Used to swap wording for pricing term units\nfunction convertUnitTerm(term){switch(term){case\"Days\":return\"daily\";case\"Months\":return\"monthly\";case\"Years\":return\"yearly\";}return term;}// Execute the cancellation operation\nvar handleCancel=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var requestHeaders,raw,requestOptions;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:requestHeaders=new Headers();requestHeaders.append(\"X-Requested-With\",\"XMLHttpRequest\");requestHeaders.append(\"Authorization\",\"Bearer \"+token);requestHeaders.append(\"Content-Type\",\"application/json\");date.setUTCHours(23,59,59,0);raw=JSON.stringify({assetIds:[selectedAsset.Id],cancellationDate:moment.utc(date,\"MM-DD-YYYY\").add(1,\"days\").format(\"YYYY-MM-DDTHH:mm:ss.SSS[Z]\")});requestOptions={method:\"POST\",headers:requestHeaders,body:raw,redirect:\"follow\"};// API call to initiate the cancellation flow\n_context2.next=9;return fetch(\"\".concat(BASE_URL,\"/asset-management/assets/collection/actions/initiate-cancellation\"),requestOptions).then(function(response){return response.text();}).then(/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(result){var id,timer;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:id=JSON.parse(result).requestId;timer=setInterval(function(){if(events.has(id)){clearInterval(timer);var message=events.get(id);if(message.payload.HasErrors){alert(\"Error during cancellation. Please try again.\");console.log('Error event detail: ',message);}else{alert(\"Cancellation order has been created for \".concat(selectedAsset.Name,\".\"));}events.clear();}},2000);case 2:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref3.apply(this,arguments);};}()).catch(function(error){return console.log(\"error\",error);});case 9:handleDialogClose();case 10:case\"end\":return _context2.stop();}}},_callee2);}));return function handleCancel(){return _ref2.apply(this,arguments);};}();// Reset values after the popup is closed for an item\nvar handleDialogClose=function handleDialogClose(){setOpen(false);setSelectedAsset(null);};function fetchPricingData(){return _fetchPricingData.apply(this,arguments);}function _fetchPricingData(){_fetchPricingData=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(){var pricingData,requestHeaders,pricingMap,requestOptions,requestUrl;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:pricingData=[];requestHeaders=new Headers();pricingMap=new Map();// Use token acquired at login\nrequestHeaders.append(\"Authorization\",\"Bearer \"+token);requestHeaders.append(\"Content-Type\",\"application/json\");requestOptions={method:\"GET\",headers:requestHeaders,redirect:\"follow\"};// API call URL to fetch pricebook entries for correlating assets to product data\nrequestUrl=\"\".concat(BASE_URL,\"/queryAll/?q=SELECT Id,Name,Product2Id, Product2.Name, ProductSellingModelId,ProductSellingModel.Name,ProductSellingModel.PricingTerm,ProductSellingModel.PricingTermUnit,ProductSellingModel.SellingModelType FROM PricebookEntry WHERE Pricebook2Id = '\",\"\".concat(process.env.REACT_APP_PRICEBOOK_ID),\"' AND IsActive = true AND CurrencyIsoCode = 'USD'\");_context4.next=9;return fetch(requestUrl,requestOptions).then(function(response){return response.text();}).then(/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(result){var index;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:pricingData=JSON.parse(result).records;// Create a map of product2 ids to pricebook entries\n// Create a map of product2 ids to pricebook entries\nindex=0;for(index;index<pricingData.length;index++){pricingMap.set(pricingData[index].Product2Id,pricingData[index]);}case 3:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x2){return _ref4.apply(this,arguments);};}()).catch(function(error){return console.log(\"error\",error);});case 9:return _context4.abrupt(\"return\",pricingMap);case 10:case\"end\":return _context4.stop();}}},_callee4);}));return _fetchPricingData.apply(this,arguments);}function fetchAssetData(){return _fetchAssetData.apply(this,arguments);}// Wait for API calls to finish before terminating loading\nfunction _fetchAssetData(){_fetchAssetData=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(){var assetData,requestHeaders,requestOptions,assetList,requestUrl;return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:assetData=[];requestHeaders=new Headers();// Use token acquired at login\nrequestHeaders.append(\"Authorization\",\"Bearer \"+token);requestHeaders.append(\"Content-Type\",\"application/json\");requestOptions={method:\"GET\",headers:requestHeaders,redirect:\"follow\"};assetList=[];// API call URL to get all assets\nrequestUrl=\"\".concat(BASE_URL,\"/queryAll/?q=SELECT Id, Name, Price, Product2Id, PurchaseDate,CurrentQuantity,LifecycleStartDate, LifecycleEndDate FROM Asset WHERE CreatedById = '\").concat(localStorage.getItem(\"userid\"),\"' ORDER BY LifecycleStartDate DESC\");_context7.next=9;return fetch(requestUrl,requestOptions).then(function(response){return response.text();}).then(/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(result){var pricingMap,index,assetIds,currentAsset,bsgReqUrl;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:assetData=JSON.parse(result).records;_context6.next=3;return fetchPricingData();case 3:pricingMap=_context6.sent;// Use the map to get selling model data for each asset\nindex=0;assetIds=[];for(index;index<assetData.length;index++){currentAsset=assetData[index];assetIds.push(currentAsset.Id);if(pricingMap.has(currentAsset.Product2Id)){currentAsset.ProductSellingModel=pricingMap.get(currentAsset.Product2Id).ProductSellingModel;currentAsset.Status='Active';currentAsset.Period=moment.utc(currentAsset.LifecycleStartDate).format(\"MMM DD, YYYY\").toString()+' - ';if(currentAsset.LifecycleEndDate){currentAsset.Period+=moment.utc(currentAsset.LifecycleEndDate).format(\"MMM DD, YYYY\").toString();if(currentAsset.ProductSellingModel.SellingModelType==='Evergreen'){currentAsset.Status='Cancelled';}}currentAsset.SellingModelType=SELLING_MODEL_TYPES[currentAsset.ProductSellingModel.SellingModelType];assetList.push(currentAsset);}}console.log('All assets',assetList);if(!(assetIds.length>0)){_context6.next=12;break;}bsgReqUrl=\"\".concat(BASE_URL,\"/queryAll/?q=SELECT Id, ReferenceEntity.Id, EffectiveNextBillingDate, CurrentBillingPeriodAmount, TotalPendingAmount FROM BillingScheduleGroup WHERE ReferenceEntity.Id IN ('\").concat(assetIds.join('\\', \\''),\"')\");_context6.next=12;return fetch(bsgReqUrl,requestOptions).then(function(response){return response.text();}).then(/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(result){var bsgRecords;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:bsgRecords=JSON.parse(result).records;bsgRecords.forEach(function(r){var assetId=r.ReferenceEntity.Id;var asset=assetList.find(function(a){return a.Id===assetId;});if(asset){if(r.EffectiveNextBillingDate){asset.NextBillingDate=moment.utc(r.EffectiveNextBillingDate).format(\"MMM DD, YYYY\").toString();}else{asset.NextBillingDate='N/A';}}});console.log('got bsg result',bsgRecords);case 3:case\"end\":return _context5.stop();}}},_callee5);}));return function(_x4){return _ref6.apply(this,arguments);};}());case 12:case\"end\":return _context6.stop();}}},_callee6);}));return function(_x3){return _ref5.apply(this,arguments);};}()).catch(function(error){return console.log(\"error\",error);});case 9:setAssets(assetList);case 10:case\"end\":return _context7.stop();}}},_callee7);}));return _fetchAssetData.apply(this,arguments);}function populateData(){return _populateData.apply(this,arguments);}function _populateData(){_populateData=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(){return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:_context8.next=2;return fetchAssetData();case 2:setLoading(false);case 3:case\"end\":return _context8.stop();}}},_callee8);}));return _populateData.apply(this,arguments);}useEffect(function(){socket.on(\"AssetEvent\",function(message){events.set(message.payload.RequestId,message);});populateData();},[cart]);return/*#__PURE__*/React.createElement(\"div\",null,loading?/*#__PURE__*/React.createElement(\"img\",{style:{margin:\"auto\",display:\"flex\"},src:loadingImg}):/*#__PURE__*/React.createElement(\"div\",{className:\"container\"},/*#__PURE__*/React.createElement(\"div\",{className:\"page-header\"},/*#__PURE__*/React.createElement(\"div\",{style:{'padding-left':'1em'}},/*#__PURE__*/React.createElement(\"h5\",null,\"What I Own\"),\"See the list of your assets, and make changes to them.\"),/*#__PURE__*/React.createElement(\"img\",{className:\"header-image\",src:ownedImg})),assets.length===0?/*#__PURE__*/React.createElement(\"h5\",{style:{textAlign:\"center\"}},\"No products found.\"):/*#__PURE__*/React.createElement(\"div\",null,assets.map(function(asset){return/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(\"ul\",{className:\"collection\",style:{width:\"100%\",margin:\"auto\"}},/*#__PURE__*/React.createElement(\"li\",{className:\"collection-item\",key:asset.Id},/*#__PURE__*/React.createElement(Container,{style:{width:\"100%\"}},/*#__PURE__*/React.createElement(Row,null,/*#__PURE__*/React.createElement(Col,{style:{width:\"78%\",marginLeft:\"2%\"}},/*#__PURE__*/React.createElement(Row,null,/*#__PURE__*/React.createElement(\"div\",{className:\"item-desc\"},/*#__PURE__*/React.createElement(\"h5\",{style:{overflowWrap:\"break-word\"}},asset.Name,/*#__PURE__*/React.createElement(\"span\",{className:asset.Status=='Active'?'new green badge':'new red badge',\"data-badge-caption\":\"\"},asset.Status)))),/*#__PURE__*/React.createElement(Row,null,/*#__PURE__*/React.createElement(\"p\",null,asset.CurrentQuantity&&/*#__PURE__*/React.createElement(\"span\",null,asset.CurrentQuantity,\" user\",asset.CurrentQuantity>1&&/*#__PURE__*/React.createElement(\"span\",null,\"s\"),\" | \"),asset.SellingModelType,\" | \",asset.ProductSellingModel.SellingModelType&&/*#__PURE__*/React.createElement(\"span\",null,asset.ProductSellingModel.SellingModelType==TERM_DEFINED&&/*#__PURE__*/React.createElement(\"span\",null,\"Term:\",\" \",asset.ProductSellingModel.PricingTerm,\" \",asset.ProductSellingModel.PricingTermUnit.toLowerCase(),\" \",\" | \"),asset.ProductSellingModel.SellingModelType==EVERGREEN&&/*#__PURE__*/React.createElement(\"span\",null,\"Billing\",\" \",convertUnitTerm(asset.ProductSellingModel.PricingTermUnit)),\" \"))),/*#__PURE__*/React.createElement(Row,null,/*#__PURE__*/React.createElement(Col,null,asset.NextBillingDate&&/*#__PURE__*/React.createElement(\"span\",null,/*#__PURE__*/React.createElement(\"div\",null,\"Next Billing Date:\"),/*#__PURE__*/React.createElement(\"strong\",null,asset.NextBillingDate))),/*#__PURE__*/React.createElement(Col,null,asset.Period&&/*#__PURE__*/React.createElement(\"span\",null,/*#__PURE__*/React.createElement(\"div\",null,\"Period:\"),/*#__PURE__*/React.createElement(\"strong\",null,asset.Period))))),/*#__PURE__*/React.createElement(Col,{style:{width:\"20%\"}},/*#__PURE__*/React.createElement(\"h6\",{style:{marginTop:\"50%\",textAlign:\"center\"}},asset.Price&&/*#__PURE__*/React.createElement(\"span\",null,\"$\",asset.Price,asset.ProductSellingModel.SellingModelType!=ONE_TIME&&/*#__PURE__*/React.createElement(\"span\",null,\" \",convertUnitTerm(asset.ProductSellingModel.PricingTermUnit)),\" \"))),/*#__PURE__*/React.createElement(Col,{style:{width:\"10%\"}},/*#__PURE__*/React.createElement(Dropdown,{id:\"dd\"+asset.Id,options:{alignment:\"right\",autoTrigger:true,closeOnClick:true,constrainWidth:true,container:null,coverTrigger:true,hover:false,inDuration:150,onCloseEnd:null,onCloseStart:null,onOpenEnd:null,onOpenStart:null,outDuration:250},trigger:/*#__PURE__*/React.createElement(Button,{style:{position:\"absolute\",top:\"10%\",right:\"5%\",backgroundColor:\"#13334C\"},id:\"db\"+asset.Id,node:\"button\"},\"Options\")},/*#__PURE__*/React.createElement(\"a\",{href:\"#\"},\"Amend\"),asset.LifecycleEndDate!=null&&/*#__PURE__*/React.createElement(\"a\",{href:\"#\"},\"Renew\"),asset.LifecycleEndDate==null&&/*#__PURE__*/React.createElement(\"a\",{onClick:function onClick(){setSelectedAsset(asset);setOpen(true);}},\"Cancel\"))))))),/*#__PURE__*/React.createElement(\"br\",null));}),selectedAsset?/*#__PURE__*/React.createElement(Dialog,{open:open,onClose:handleDialogClose,\"aria-labelledby\":\"alert-dialog-title\",\"aria-describedby\":\"alert-dialog-description\",fullWidth:true,maxWidth:\"sm\"},/*#__PURE__*/React.createElement(DialogTitle,{id:\"alert-dialog-title\"},\"Cancel \",selectedAsset.Name),/*#__PURE__*/React.createElement(DialogContent,{style:{height:\"40vh\"}},/*#__PURE__*/React.createElement(\"p\",null,\"Cancellation date:\",\" \",/*#__PURE__*/React.createElement(DatePicker,{minDate:new Date(),onChange:onDateChange,value:date}))),/*#__PURE__*/React.createElement(DialogActions,null,/*#__PURE__*/React.createElement(Button,{onClick:handleCancel,color:\"primary\"},\"Cancel subscription\"))):\"\")));}","map":{"version":3,"sources":["/Users/bgaldino/Documents/self-service-webstore/frontend/src/components/Assets/Assets.js"],"names":["React","useEffect","useState","useToken","Col","Container","Row","moment","Button","Dropdown","Dialog","DialogActions","DialogContent","DialogTitle","DatePicker","io","loadingImg","ownedImg","TERM_DEFINED","ONE_TIME","EVERGREEN","SELLING_MODEL_TYPES","SOCKET_ENDPOINT","BASE_URL","process","env","REACT_APP_API_ENDPOINT","REACT_APP_API_VERSION","Assets","setCart","cart","token","setToken","assets","setAssets","open","setOpen","selectedAsset","setSelectedAsset","Date","date","onDateChange","loading","setLoading","Map","events","socket","transports","convertUnitTerm","term","handleCancel","requestHeaders","Headers","append","setUTCHours","raw","JSON","stringify","assetIds","Id","cancellationDate","utc","add","format","requestOptions","method","headers","body","redirect","fetch","then","response","text","result","id","parse","requestId","timer","setInterval","has","clearInterval","message","get","payload","HasErrors","alert","console","log","Name","clear","catch","error","handleDialogClose","fetchPricingData","pricingData","pricingMap","requestUrl","REACT_APP_PRICEBOOK_ID","records","index","length","set","Product2Id","fetchAssetData","assetData","assetList","localStorage","getItem","currentAsset","push","ProductSellingModel","Status","Period","LifecycleStartDate","toString","LifecycleEndDate","SellingModelType","bsgReqUrl","join","bsgRecords","forEach","r","assetId","ReferenceEntity","asset","find","a","EffectiveNextBillingDate","NextBillingDate","populateData","on","RequestId","margin","display","textAlign","map","width","marginLeft","overflowWrap","CurrentQuantity","PricingTerm","PricingTermUnit","toLowerCase","marginTop","Price","alignment","autoTrigger","closeOnClick","constrainWidth","container","coverTrigger","hover","inDuration","onCloseEnd","onCloseStart","onOpenEnd","onOpenStart","outDuration","position","top","right","backgroundColor","height"],"mappings":"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","sourcesContent":["import React, { useEffect, useState } from \"react\";\nimport useToken from \"../useToken\";\nimport { Col, Container, Row } from \"react-bootstrap\";\nimport moment from \"moment\";\nimport { Button, Dropdown } from \"react-materialize\";\nimport {\n  Dialog,\n  DialogActions,\n  DialogContent,\n  DialogTitle,\n} from \"@material-ui/core\";\nimport DatePicker from \"react-date-picker\";\nimport io from \"socket.io-client\";\nimport loadingImg from \"../../images/loading.gif\";\nimport ownedImg from \"../../images/owned.png\";\nimport \"./Assets.css\";\n\nconst TERM_DEFINED = \"TermDefined\";\nconst ONE_TIME = \"OneTime\";\nconst EVERGREEN = \"Evergreen\";\nconst SELLING_MODEL_TYPES = {\n  'OneTime': 'One Time',\n  'Evergreen': 'Evergreen',\n  'TermDefined': 'Term Defined'\n}\n\nconst SOCKET_ENDPOINT = \"https://self-service-webstore.herokuapp.com/\";\nconst BASE_URL = `${process.env.REACT_APP_API_ENDPOINT}/services/data/v${process.env.REACT_APP_API_VERSION}`;\n\nexport default function Assets({ setCart, cart }) {\n  const { token, setToken } = useToken();\n  const [assets, setAssets] = useState([]);\n\n  const [open, setOpen] = useState(false); // State of popup dialog\n  const [selectedAsset, setSelectedAsset] = useState(null); // Asset data for popup\n\n  const [date, onDateChange] = useState(new Date());\n\n  const [loading, setLoading] = useState(true);\n  const [events] = useState(new Map());\n\n  // Create socket.io connection for streaming messages\n  let socket = io(SOCKET_ENDPOINT, {\n    transports: [\"websocket\", \"polling\", \"flashsocket\", \"xhr-polling\"],\n  });\n\n  // Used to swap wording for pricing term units\n  function convertUnitTerm(term) {\n    switch (term) {\n      case \"Days\":\n        return \"daily\";\n      case \"Months\":\n        return \"monthly\";\n      case \"Years\":\n        return \"yearly\";\n    }\n    return term;\n  }\n\n  // Execute the cancellation operation\n  const handleCancel = async () => {\n    let requestHeaders = new Headers();\n    requestHeaders.append(\"X-Requested-With\", \"XMLHttpRequest\");\n    requestHeaders.append(\"Authorization\", \"Bearer \" + token);\n    requestHeaders.append(\"Content-Type\", \"application/json\");\n    date.setUTCHours(23, 59, 59, 0);\n    let raw = JSON.stringify({\n      assetIds: [selectedAsset.Id],\n      cancellationDate: moment\n        .utc(date, \"MM-DD-YYYY\")\n        .add(1, \"days\")\n        .format(\"YYYY-MM-DDTHH:mm:ss.SSS[Z]\")\n    });\n\n    let requestOptions = {\n      method: \"POST\",\n      headers: requestHeaders,\n      body: raw,\n      redirect: \"follow\",\n    };\n\n    // API call to initiate the cancellation flow\n    await fetch(\n      `${BASE_URL}/asset-management/assets/collection/actions/initiate-cancellation`,\n      requestOptions\n    )\n      .then((response) => response.text())\n      .then(async (result) => {\n        let id = JSON.parse(result).requestId;\n        let timer = setInterval(() => {\n          if (events.has(id)) {\n            clearInterval(timer);\n            let message = events.get(id);\n            if (message.payload.HasErrors) {\n              alert(\"Error during cancellation. Please try again.\");\n\t      console.log('Error event detail: ', message);\n            } else {\n              alert(\n                `Cancellation order has been created for ${selectedAsset.Name}.`\n              );\n            }\n            events.clear();\n          }\n        }, 2000);\n      })\n      .catch((error) => console.log(\"error\", error));\n    handleDialogClose();\n  };\n\n  // Reset values after the popup is closed for an item\n  const handleDialogClose = () => {\n    setOpen(false);\n    setSelectedAsset(null);\n  };\n\n  async function fetchPricingData() {\n    let pricingData = [];\n    let requestHeaders = new Headers();\n    let pricingMap = new Map();\n    // Use token acquired at login\n    requestHeaders.append(\"Authorization\", \"Bearer \" + token);\n    requestHeaders.append(\"Content-Type\", \"application/json\");\n\n    let requestOptions = {\n      method: \"GET\",\n      headers: requestHeaders,\n      redirect: \"follow\",\n    };\n\n    // API call URL to fetch pricebook entries for correlating assets to product data\n    let requestUrl = `${BASE_URL}/queryAll/?q=SELECT Id,Name,Product2Id, Product2.Name, ProductSellingModelId,ProductSellingModel.Name,ProductSellingModel.PricingTerm,ProductSellingModel.PricingTermUnit,ProductSellingModel.SellingModelType FROM PricebookEntry WHERE Pricebook2Id = '${`${process.env.REACT_APP_PRICEBOOK_ID}`}' AND IsActive = true AND CurrencyIsoCode = 'USD'`;\n    await fetch(requestUrl, requestOptions)\n      .then((response) => response.text())\n      .then(async (result) => {\n        pricingData = JSON.parse(result).records;\n        // Create a map of product2 ids to pricebook entries\n        let index = 0;\n        for (index; index < pricingData.length; index++) {\n          pricingMap.set(pricingData[index].Product2Id, pricingData[index]);\n        }\n      })\n      .catch((error) => console.log(\"error\", error));\n    return pricingMap;\n  }\n\n  async function fetchAssetData() {\n    let assetData = [];\n\n    let requestHeaders = new Headers();\n\n    // Use token acquired at login\n    requestHeaders.append(\"Authorization\", \"Bearer \" + token);\n    requestHeaders.append(\"Content-Type\", \"application/json\");\n\n    let requestOptions = {\n      method: \"GET\",\n      headers: requestHeaders,\n      redirect: \"follow\",\n    };\n\n    let assetList = [];\n\n    // API call URL to get all assets\n    let requestUrl = `${BASE_URL}/queryAll/?q=SELECT Id, Name, Price, Product2Id, PurchaseDate,CurrentQuantity,LifecycleStartDate, LifecycleEndDate FROM Asset WHERE CreatedById = '${localStorage.getItem(\"userid\")}' ORDER BY LifecycleStartDate DESC`;\n    await fetch(requestUrl, requestOptions)\n      .then((response) => response.text())\n      .then(async (result) => {\n        assetData = JSON.parse(result).records;\n        let pricingMap = await fetchPricingData();\n        // Use the map to get selling model data for each asset\n        let index = 0;\n        const assetIds = [];\n        for (index; index < assetData.length; index++) {\n          let currentAsset = assetData[index];\n          assetIds.push(currentAsset.Id);\n          if (pricingMap.has(currentAsset.Product2Id)) {\n            currentAsset.ProductSellingModel = pricingMap.get(\n              currentAsset.Product2Id\n            ).ProductSellingModel;\n            currentAsset.Status = 'Active';\n            currentAsset.Period = moment\n                .utc(currentAsset.LifecycleStartDate)\n                .format(\"MMM DD, YYYY\")\n                .toString() + ' - ';\n            if (currentAsset.LifecycleEndDate) {\n              currentAsset.Period += moment\n                  .utc(currentAsset.LifecycleEndDate)\n                  .format(\"MMM DD, YYYY\")\n                  .toString();\n              if (currentAsset.ProductSellingModel.SellingModelType === 'Evergreen') {\n                currentAsset.Status = 'Cancelled';\n              }\n            }\n            currentAsset.SellingModelType = SELLING_MODEL_TYPES[currentAsset.ProductSellingModel.SellingModelType];\n            assetList.push(currentAsset);\n          }\n        }\n        console.log('All assets', assetList);\n        if (assetIds.length > 0) {\n          const bsgReqUrl = `${BASE_URL}/queryAll/?q=SELECT Id, ReferenceEntity.Id, EffectiveNextBillingDate, CurrentBillingPeriodAmount, TotalPendingAmount FROM BillingScheduleGroup WHERE ReferenceEntity.Id IN ('${assetIds.join('\\', \\'')}')`;\n          await fetch(bsgReqUrl, requestOptions)\n            .then((response) => response.text())\n            .then(async (result) => {\n              const bsgRecords = JSON.parse(result).records;\n              bsgRecords.forEach(r => {\n                const assetId = r.ReferenceEntity.Id;\n                const asset = assetList.find(a => a.Id === assetId);\n                if (asset) {\n                  if (r.EffectiveNextBillingDate) {\n                    asset.NextBillingDate = moment.utc(r.EffectiveNextBillingDate).format(\"MMM DD, YYYY\").toString();\n                  } else {\n                    asset.NextBillingDate = 'N/A';\n                  }\n                }\n              })\n              console.log('got bsg result', bsgRecords);\n            });\n        }\n      })\n      .catch((error) => console.log(\"error\", error));\n    setAssets(assetList);\n  }\n\n  // Wait for API calls to finish before terminating loading\n  async function populateData() {\n    await fetchAssetData();\n    setLoading(false);\n  }\n\n  useEffect(() => {\n    socket.on(\"AssetEvent\", (message) => {\n      events.set(message.payload.RequestId, message);\n    });\n    populateData();\n  }, [cart]);\n\n  return (\n    <div>\n      {loading ? (\n        <img style={{ margin: \"auto\", display: \"flex\" }} src={loadingImg} />\n      ) : (\n        <div className=\"container\">\n          <div className=\"page-header\">\n            <div style={{'padding-left': '1em'}}>\n              <h5>What I Own</h5>\n              See the list of your assets, and make changes to them.\n            </div>\n            <img className=\"header-image\" src={ownedImg}/>\n          </div>\n          {assets.length === 0 ? (\n            <h5 style={{ textAlign: \"center\" }}>No products found.</h5>\n          ) : (\n            <div>\n              {assets.map((asset) => (\n                <div>\n                  <ul\n                    className=\"collection\"\n                    style={{ width: \"100%\", margin: \"auto\" }}\n                  >\n                    <li className=\"collection-item\" key={asset.Id}>\n                      <Container style={{ width: \"100%\" }}>\n                        <Row>\n                          <Col style={{ width: \"78%\", marginLeft: \"2%\" }}>\n                            <Row>\n                              <div className=\"item-desc\">\n                                <h5 style={{ overflowWrap: \"break-word\" }}>\n                                  {asset.Name}\n                                  <span className={asset.Status == 'Active' ? 'new green badge' : 'new red badge'}\n                                        data-badge-caption=\"\">\n                                  {asset.Status}\n                                </span>\n                                </h5>\n                              </div>\n                            </Row>\n                            <Row>\n                              <p>\n                                {asset.CurrentQuantity && (\n                                  <span>\n                                    {asset.CurrentQuantity} user\n                                    {asset.CurrentQuantity > 1 && <span>s</span>}\n                                    {\" | \"}\n                                  </span>\n                                )}\n                                {asset.SellingModelType}{\" | \"}\n                                {asset.ProductSellingModel.SellingModelType && (\n                                  <span>\n                                    {asset.ProductSellingModel\n                                      .SellingModelType == TERM_DEFINED && (\n                                      <span>\n                                        Term:{\" \"}\n                                        {asset.ProductSellingModel.PricingTerm}{\" \"}\n                                        {asset.ProductSellingModel.PricingTermUnit.toLowerCase()}{\" \"}\n                                        {\" | \"}\n                                      </span>\n                                    )}\n                                    {asset.ProductSellingModel\n                                      .SellingModelType == EVERGREEN && (\n                                      <span>\n                                        Billing{\" \"}\n                                        {convertUnitTerm(\n                                          asset.ProductSellingModel\n                                            .PricingTermUnit\n                                        )}\n                                      </span>\n                                    )}{\" \"}\n                                  </span>\n                                )}\n                              </p>\n                            </Row>\n                            <Row>\n                              <Col>\n                                {asset.NextBillingDate && (\n                                    <span>\n                                      <div>Next Billing Date:</div>\n                                      <strong>{asset.NextBillingDate}</strong>\n                                  </span>\n                                )}\n                              </Col>\n                              <Col>\n                                {asset.Period && (\n                                  <span>\n                                    <div>Period:</div>\n                                    <strong>{asset.Period}</strong>\n                                  </span>\n                                )}\n                              </Col>\n                            </Row>\n                          </Col>\n                          <Col style={{ width: \"20%\" }}>\n                            <h6\n                              style={{ marginTop: \"50%\", textAlign: \"center\" }}\n                            >\n                              {asset.Price && (\n                                <span>\n                                  ${asset.Price}\n                                  {asset.ProductSellingModel.SellingModelType !=\n                                    ONE_TIME && (\n                                    <span>\n                                      {\" \"}\n                                      {convertUnitTerm(\n                                        asset.ProductSellingModel\n                                          .PricingTermUnit\n                                      )}\n                                    </span>\n                                  )}{\" \"}\n                                </span>\n                              )}\n                            </h6>\n                          </Col>\n\n                          <Col style={{ width: \"10%\" }}>\n                            <Dropdown\n                              id={\"dd\" + asset.Id}\n                              options={{\n                                alignment: \"right\",\n                                autoTrigger: true,\n                                closeOnClick: true,\n                                constrainWidth: true,\n                                container: null,\n                                coverTrigger: true,\n                                hover: false,\n                                inDuration: 150,\n                                onCloseEnd: null,\n                                onCloseStart: null,\n                                onOpenEnd: null,\n                                onOpenStart: null,\n                                outDuration: 250,\n                              }}\n                              trigger={\n                                <Button\n                                  style={{\n                                    position: \"absolute\",\n                                    top: \"10%\",\n                                    right: \"5%\",\n                                    backgroundColor: \"#13334C\",\n                                  }}\n                                  id={\"db\" + asset.Id}\n                                  node=\"button\"\n                                >\n                                  Options\n                                </Button>\n                              }\n                            >\n                              <a href=\"#\">Amend</a>\n                              {asset.LifecycleEndDate != null && (\n                                <a href=\"#\">Renew</a>\n                              )}\n                              {asset.LifecycleEndDate == null && (\n                                <a\n                                  onClick={() => {\n                                    setSelectedAsset(asset);\n                                    setOpen(true);\n                                  }}\n                                >\n                                  Cancel\n                                </a>\n                              )}\n                            </Dropdown>\n                          </Col>\n                        </Row>\n                      </Container>\n                    </li>\n                  </ul>\n                  <br />\n                </div>\n              ))}\n              {/* Control the content of the dialog based on which product has been selected */}\n              {selectedAsset ? (\n                <Dialog\n                  open={open}\n                  onClose={handleDialogClose}\n                  aria-labelledby=\"alert-dialog-title\"\n                  aria-describedby=\"alert-dialog-description\"\n                  fullWidth\n                  maxWidth=\"sm\"\n                >\n                  <DialogTitle id=\"alert-dialog-title\">\n                    Cancel {selectedAsset.Name}\n                  </DialogTitle>\n                  <DialogContent style={{ height: \"40vh\" }}>\n                    <p>\n                      Cancellation date:{\" \"}\n                      <DatePicker\n                        minDate={new Date()}\n                        onChange={onDateChange}\n                        value={date}\n                      />\n                    </p>\n                  </DialogContent>\n                  <DialogActions>\n                    <Button onClick={handleCancel} color=\"primary\">\n                      Cancel subscription\n                    </Button>\n                  </DialogActions>\n                </Dialog>\n              ) : (\n                \"\"\n              )}\n            </div>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n"]},"metadata":{},"sourceType":"module"}